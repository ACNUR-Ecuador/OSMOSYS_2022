<div class="grid">
    <div class="col-12">
        <p-toast></p-toast>
        <div class="card px-6 py-6">
            <p-table #dt [value]="items" [columns]="selectedColumns" [rows]="10" 
                [paginator]="true" [rowHover]="true" dataKey="id"
                styleClass="p-datatable-striped" 
                currentPageReportTemplate=" {first} a {last} de {totalRecords} "
                [showCurrentPageReport]="true"
                (sortFunction)="utilsService.customSort($event, cols)" [customSort]="true" 
                [rowsPerPageOptions]="[10,25,50]">
            <ng-template pTemplate="caption">
                    <div class="grid">
                        <div class="col-12 md:col-4 sm:col-12 flex justify-content-start">
                            <h3 class="m-0">Indicadores de Mánager de Resultado</h3>
                        </div>
                        <div class="col-12 md:col-3 sm:col-12 flex justify-content-center">
                                <form [formGroup]="periodForm">
                                        <label for="periodI2" class="col-fixed" style="color: rgb(91, 91, 91);">Año:</label>
                                        <p-dropdown id="periodI2" [options]="periods" optionLabel="year"
                                                    formControlName="selectedPeriod"
                                                    (onChange)="onPeriodChange($event.value)"
                                                    appendTo="body"></p-dropdown>
                                </form>
                        </div>
                        
                        <div class="col-12 md:col-5 sm:col-12 flex justify-content-end">

                           
                        </div>
                    </div>
            </ng-template>
    <ng-template pTemplate="header" let-columns>
        <tr>
            <th style="width: 3rem"></th> <!-- Columna para el botón de expansión -->
            <th *ngFor="let col of columns" [pSortableColumn]="col.field">
                {{col.header}}
                <p-sortIcon [field]="col.field"></p-sortIcon>
            </th>
        
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-rowData let-columns="columns">
        <tr>
            <td>
                <button pButton pRipple type="button"
                        [icon]="expandedRowKeys[rowData.indicator.id] ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"
                        [pRowToggler]="rowData"
                        (click)="toggleRow(rowData)"
                        [disabled]="!rowData.hasExecutions">
                </button>


            </td>
            <td *ngFor="let col of columns">
                <!-- Condición para 'hasExecutions' -->
                <ng-container *ngIf="col.field === 'hasExecutions'">
                  <p-tag *ngIf="rowData.hasExecutions" severity="success" value="Tiene Ejecuciones" class="custom-ptag"></p-tag>
                  <p-tag *ngIf="!rowData.hasExecutions" severity="danger" value="Sin Ejecuciones" class="custom-ptag"></p-tag>
                </ng-container>
                <!-- Lógica para confirmation -->
                <ng-container *ngIf="col.field === 'confirmation'">
                    <span [ngClass]="{
                      'lateConfirm': getAnualConfirmationRate(rowData).confirmationStatus === 'late',
                      'progressConfirm': getAnualConfirmationRate(rowData).confirmationStatus === 'inProgress',
                      'completedConfirm': getAnualConfirmationRate(rowData).confirmationStatus === 'completed',
                      'onTimeConfirm': getAnualConfirmationRate(rowData).confirmationStatus === 'onTime'
                    }">{{ getAnualConfirmationRate(rowData).confirmationRate }}</span>
                  </ng-container>
                <!-- Lógica normal para los otros campos -->
                <ng-container *ngIf="col.field !== 'hasExecutions' && col.field !== 'confirmation'">
                  {{ col.pipeRef ? col.pipeRef.transform(utilsService.resolveFieldData(rowData, col.field)) : utilsService.resolveFieldData(rowData, col.field) }}
                </ng-container>
              </td>
        
        </tr>
        <!-- Sección de expansión -->
        <tr *ngIf="expandedRowKeys[rowData.indicator.id]">
            <td colspan="100%">
                <div class="p-3">
                    <h5>Detalles por Trimestre</h5>
                    <p-table [value]="rowData.resultManagerIndicatorQuarter" dataKey="quarter" >
                        <ng-template pTemplate="header">
                            <tr>
                                <th style="width: 15%;">Trimestre</th>
                                <th style="width: 15%;">Ejecución Trimestral</th>
                                <th style="width: 15%;">Confirmación Trimestral</th>
                                <th style="width: 55%; text-align: center;">Detalles</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-quarterData>
                            <tr>
                                <td>{{ quarterData.quarter }}</td>
                                <td>{{ quarterData.quarterExecution }}</td>
                                <td>
                                    <span [ngClass]="{
                                        'lateConfirm': getQuarterConfirmationRate(quarterData).confirmationStatus === 'late',
                                        'progressConfirm': getQuarterConfirmationRate(quarterData).confirmationStatus === 'inProgress',
                                        'completedConfirm': getQuarterConfirmationRate(quarterData).confirmationStatus === 'completed',
                                        'onTimeConfirm': getQuarterConfirmationRate(quarterData).confirmationStatus === 'onTime'
                                      }">
                                        {{getQuarterConfirmationRate(quarterData).confirmationRate}}</span>
                                </td>
                                <td>
                                    <div style="display: flex; gap: 10px; width: 100%; justify-content: center;">
                                        <button pButton icon="pi pi-check-square" label="Ver por Tipo de Población"
                                            class="p-button p-button-primary p-mr-2"
                                            
                                            (click)="showDissPopulationView(quarterData,rowData.indicator)">
        
                                        </button>
                                        <button pButton icon="pi pi-eye" label="Ver por Implementación"
                                            class="p-button p-button-primary p-mr-2"
                                            style="background-color: #589BE5; border: none;"
                                            (click)="showImplementationTypeView(quarterData.resultManagerQuarterImplementer)">
                                        </button>
                                        <button pButton icon="pi pi-file" label="Reporte Trimestral"
                                            class="p-button p-button-info p-mr-2"
                                            (click)="op.toggle($event)">
                                        </button>
                                        <p-overlayPanel #op (onHide)="cancelOverlayPanel()">
                                          <ng-template pTemplate>
                                            <div class="card">
                                              <div *ngIf="rowData.indicator.quarterReportCalculation==='ALL_REPORT_SUM'" class="overlay-content-report">
                                                        <label style="font-size: 14px;"><strong>Verifico que los valores reportados son correctos</strong></label>
                                                      <br>
                                                
                                                      <!-- Radio button para "Sí" -->
                                                      <p-radioButton
                                                        name="allReportSumConfirmation"
                                                        [(ngModel)]="quarterData.allReportSumConfirmation"
                                                        [value]="true"
                                                        label="Sí"
                                                        class="overlay-radio-button">
                                                      </p-radioButton>
                                                
                                                      <!-- Radio button para "No" -->
                                                      <p-radioButton
                                                        name="allReportSumConfirmation"
                                                        [(ngModel)]="quarterData.allReportSumConfirmation"
                                                        [value]="false"
                                                        label="No"
                                                        class="overlay-radio-button">
                                                      </p-radioButton>
                                              </div>
                                              <div *ngIf="rowData.indicator.quarterReportCalculation==='AGGREGATION_RULE'" class="overlay-content-report">
                                                <label style="font-size: 14px; text-align: center;"><strong>Reporte Trimestral por regla de agregación</strong></label>

                                                <p-messages severity="warn">
                                                  <ng-template pTemplate>
                                                      <span class="custom-message" style="color: #D9A301; margin-right: 0.5rem;font-weight: bold;">RECUERDA, 
                                                        <span class="custom-message"style="color: #6d5100; font-weight: normal;"> {{rowData.indicator.aggregationRuleComment}}</span>
                                                      </span>
                                                  </ng-template>
                                                </p-messages>
                                                  
                                                <div class="overlay-newvalue-container ">
                                                  <label for="newReportValueI">Nuevo valor a reportar en el trimestre: *</label>
                                                  <input type="number" pInputText id="newReportValueI"
                                                         [min]="0"
                                                         [(ngModel)]="quarterData.newReportValue" />
                                                </div>
                                                <small class="p-error" *ngIf="!quarterData.newReportValue">El valor es obligatorio</small>
                                           
                                              </div>
                                
                                              <!-- Condición para mostrar el textarea cuando se selecciona "No" -->
                                              <div *ngIf="quarterData.allReportSumConfirmation === false || rowData.indicator.quarterReportCalculation==='AGGREGATION_RULE'" class="overlay-textarea-container">
                                                <label for="reportCommentI">Comentario *:</label>
                                                <textarea pInputTextarea
                                                          id="reportCommentI"
                                                          [(ngModel)]="quarterData.reportComment"
                                                          [autoResize]="true"
                                                          rows="5"
                                                          class="overlay-comment-textarea">
                                                </textarea>
                                        
                                                <small class="p-error" *ngIf="(quarterData.allReportSumConfirmation === false || rowData.indicator.quarterReportCalculation==='AGGREGATION_RULE') && !quarterData.reportComment">
                                                  El comentario es obligatorio
                                                </small>
                                              </div>
                                        
                                              <!-- Botones de acción -->
                                              <div class="overlay-button-group">
                                                <button type="button" pButton label="Guardar" icon="pi pi-check" class="p-button-primary" 
                                                        (click)="saveQuarterReport(quarterData,rowData.indicator)" [disabled]="validateReportForm(quarterData,rowData.indicator)">
                                                </button>
                                                <button pButton type="button" pRipple label="Cancelar" icon="pi pi-times" class="p-button-secondary"
                                                        (click)="op.toggle($event)">
                                                </button>
                                              </div>
                                            </div>
                                          </ng-template>
                                        </p-overlayPanel>                                        
                                    

                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                    
                </div>
            </td>
        </tr>
    </ng-template>

</p-table>


        </div>
    </div>
</div>

<!--Population Type View -->
    <p-dialog [(visible)]="showPopulationDialog" [style]="{width: '60%'}" header="Ejecución por Tipo de Población" [modal]="true"
              [closable]="false">
        <ng-template pTemplate="content">
            <p-messages></p-messages>
            <br>
            <p-table [value]="tableData">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Tipo de Población</th>
                    <th>Ejecución Trimestral</th>
                    <th>Confirmado</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-row>
                  <tr>
                    <td>{{ row.populationType.name }}</td>
                    <td>{{ row.quarterPopulationTypeExecution }}</td>
                    <td>
                      <p-checkbox  [(ngModel)]="row.confirmation" [binary]="true"></p-checkbox>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
        </ng-template>

        <ng-template pTemplate="footer">
            <button *ngIf="tableData.length > 0" pButton type="button"
                    pRipple label="Guardar" icon="pi pi-check" (click)="saveItem()"
            ></button>
            <button pButton type="button" pRipple label="Cancelar" icon="pi pi-times" class="p-button-secondary"
                    (click)="cancelDialog()"></button>

        </ng-template>
    </p-dialog>
<!--Quarter Implementation Type View -->
    <p-dialog [(visible)]="showImplementationDialog" [style]="{width: '50%'}" header="Ejecución por Tipo de Implementación" [modal]="true"
              [closable]="false">
        <ng-template pTemplate="content">
            <p-messages></p-messages>
            <br>
            <p-table [value]="implTable.partnerImpl" ngClass="impl-table">
                <ng-template pTemplate="caption">
                    <h5>Implementación por Socios</h5>
                </ng-template>
                <ng-template pTemplate="header">
                  <tr>
                    <th>Socio</th>
                    <th>Ejecución Trimestral</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-row>
                  <tr>
                    <td class="table-title">{{ row.partner }}</td>
                    <td>{{ row.execution }}</td>
                  </tr>
                </ng-template>
            </p-table>
              <br>
              <p-table [value]="implTable.officeImpl" ngClass="impl-table">
                <ng-template pTemplate="caption">
                    <h5>Implementación Directa</h5>
                </ng-template>
                <ng-template pTemplate="header">
                  <tr>
                    <th>Oficina</th>
                    <th>Ejecución</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-row>
                  <tr>
                    <td class="table-title">{{ row.office }}</td>
                    <td>{{ row.execution }}</td>
                  </tr>
                </ng-template>
            </p-table>
        </ng-template>

        <ng-template pTemplate="footer">
            <button pButton type="button" pRipple label="Cerrar" icon="pi pi-times" class="p-button-secondary"
                    (click)="cancelDialog()"></button>

        </ng-template>
    </p-dialog>





