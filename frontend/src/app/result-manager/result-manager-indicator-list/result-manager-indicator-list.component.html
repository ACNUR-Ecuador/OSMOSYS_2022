<div class="grid">
    <div class="col-12">
        <p-toast></p-toast>
        <div class="card px-6 py-6">
            <p-table #dt [value]="items" [columns]="selectedColumns" [rows]="10" 
                [paginator]="true" [rowHover]="true" dataKey="id"
                styleClass="p-datatable-striped" 
                currentPageReportTemplate=" {first} a {last} de {totalRecords} "
                [showCurrentPageReport]="true"
                (sortFunction)="utilsService.customSort($event, cols)" [customSort]="true" 
                [rowsPerPageOptions]="[10,25,50]">
            <ng-template pTemplate="caption">
                    <div class="grid">
                        <div class="col-12 md:col-4 sm:col-12 flex justify-content-start">
                            <h3 class="m-0">Indicadores de Mánager de Resultado</h3>
                        </div>
                        <div class="col-12 md:col-3 sm:col-12 flex justify-content-center">
                                <form [formGroup]="periodForm">
                                        <label for="periodI2" class="col-fixed" style="color: rgb(91, 91, 91);">Año:</label>
                                        <p-dropdown id="periodI2" [options]="periods" optionLabel="year"
                                                    formControlName="selectedPeriod"
                                                    (onChange)="onPeriodChange($event.value)"
                                                    appendTo="body"></p-dropdown>
                                </form>
                        </div>
                        
                        <div class="col-12 md:col-5 sm:col-12 flex justify-content-end">

                           
                        </div>
                    </div>
            </ng-template>
    <ng-template pTemplate="header" let-columns>
        <tr>
            <th style="width: 3rem"></th> <!-- Columna para el botón de expansión -->
            <th *ngFor="let col of columns" [pSortableColumn]="col.field">
                {{col.header}}
                <p-sortIcon [field]="col.field"></p-sortIcon>
            </th>
        
        </tr>
    </ng-template>

    <ng-template pTemplate="body" let-rowData let-columns="columns">
        <tr>
            <td>
                <button pButton pRipple type="button"
                        [icon]="expandedRowKeys[rowData.indicator.id] ? 'pi pi-chevron-up' : 'pi pi-chevron-down'"
                        [pRowToggler]="rowData"
                        (click)="toggleRow(rowData)"
                        [disabled]="!rowData.hasExecutions">
                </button>


            </td>
            <td *ngFor="let col of columns">
                <!-- Condición para 'hasExecutions' -->
                <ng-container *ngIf="col.field === 'hasExecutions'">
                  <p-tag *ngIf="rowData.hasExecutions" severity="success" value="Tiene Ejecuciones" class="custom-ptag"></p-tag>
                  <p-tag *ngIf="!rowData.hasExecutions" severity="danger" value="Sin Ejecuciones" class="custom-ptag"></p-tag>
                </ng-container>
                <!-- Lógica para confirmation -->
                <ng-container *ngIf="col.field === 'confirmation'">
                    {{ getConfirmationRate(rowData) }}
                  </ng-container>
                <!-- Lógica normal para los otros campos -->
                <ng-container *ngIf="col.field !== 'hasExecutions' && col.field !== 'confirmation'">
                  {{ col.pipeRef ? col.pipeRef.transform(utilsService.resolveFieldData(rowData, col.field)) : utilsService.resolveFieldData(rowData, col.field) }}
                </ng-container>
              </td>
        
        </tr>
        <!-- Sección de expansión -->
        <tr *ngIf="expandedRowKeys[rowData.indicator.id]">
            <td colspan="6">
                <div class="p-3">
                    <h5>Detalles por Trimestre</h5>
                    <p-table [value]="rowData.resultManagerIndicatorQuarter" dataKey="quarter" >
                        <ng-template pTemplate="header">
                            <tr>
                                <th style="width: 30%;">Trimestre</th>
                                <th style="width: 30%;">Ejecución</th>
                                <th style="width: 40%; text-align: center;">Detalles</th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-quarterData>
                            <tr>
                                <td>{{ quarterData.quarter }}</td>
                                <td>{{ quarterData.quarterExecution }}</td>
                                <td>
                                    <div style="display: flex; gap: 10px; width: 100%; justify-content: center;">
                                        <button pButton icon="pi pi-eye" label="Ver por Tipo de Población"
                                            class="p-button p-button-primary p-mr-2"
                                            
                                            (click)="showDissPopulationView(quarterData,rowData.indicator)">
        
                                        </button>
                                        <button pButton icon="pi pi-eye" label="Ver por Implementación"
                                            class="p-button p-button-primary p-mr-2"
                                            style="background-color: #589BE5; border: none;"
                                            (click)="showImplementationTypeView(quarterData.resultManagerQuarterImplementer)">
                                        </button>
                                        
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                    
                </div>
            </td>
        </tr>
    </ng-template>

</p-table>


        </div>
    </div>
</div>

<!--Population Type View -->
    <p-dialog [(visible)]="showPopulationDialog" [style]="{width: '60%'}" header="Ejecución por Tipo de Población" [modal]="true"
              [closable]="false">
        <ng-template pTemplate="content">
            <p-messages></p-messages>
            <br>
            <p-table [value]="tableData">
                <ng-template pTemplate="header">
                  <tr>
                    <th>Tipo de Población</th>
                    <th>Ejecución</th>
                    <th>Confirmado</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-row>
                  <tr>
                    <td>{{ row.populationType.name }}</td>
                    <td>{{ row.quarterPopulationTypeExecution }}</td>
                    <td>
                      <p-checkbox  [(ngModel)]="row.confirmation" [binary]="true"></p-checkbox>
                    </td>
                  </tr>
                </ng-template>
              </p-table>
        </ng-template>

        <ng-template pTemplate="footer">
            <button *ngIf="tableData.length > 0" pButton type="button"
                    pRipple label="Guardar" icon="pi pi-check" (click)="saveItem()"
            ></button>
            <button pButton type="button" pRipple label="Cancelar" icon="pi pi-times" class="p-button-secondary"
                    (click)="cancelDialog()"></button>

        </ng-template>
    </p-dialog>
<!--Quarter Implementation Type View -->
    <p-dialog [(visible)]="showImplementationDialog" [style]="{width: '50%'}" header="Ejecución por Tipo de Implementación" [modal]="true"
              [closable]="false">
        <ng-template pTemplate="content">
            <p-messages></p-messages>
            <br>
            <p-table [value]="implTable.partnerImpl" ngClass="impl-table">
                <ng-template pTemplate="caption">
                    <h5>Implementación por Socios</h5>
                </ng-template>
                <ng-template pTemplate="header">
                  <tr>
                    <th>Socio</th>
                    <th>Ejecución</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-row>
                  <tr>
                    <td class="table-title">{{ row.partner }}</td>
                    <td>{{ row.execution }}</td>
                  </tr>
                </ng-template>
            </p-table>
              <br>
              <p-table [value]="implTable.officeImpl" ngClass="impl-table">
                <ng-template pTemplate="caption">
                    <h5>Implementación Directa</h5>
                </ng-template>
                <ng-template pTemplate="header">
                  <tr>
                    <th>Oficina</th>
                    <th>Ejecución</th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-row>
                  <tr>
                    <td class="table-title">{{ row.office }}</td>
                    <td>{{ row.execution }}</td>
                  </tr>
                </ng-template>
            </p-table>
        </ng-template>

        <ng-template pTemplate="footer">
            <button pButton type="button" pRipple label="Cerrar" icon="pi pi-times" class="p-button-secondary"
                    (click)="cancelDialog()"></button>

        </ng-template>
    </p-dialog>





